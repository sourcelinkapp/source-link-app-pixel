/*! For license information please see sourcelink.js.LICENSE.txt */
!function(){const e="https://asia-east2-ms-source-tracking-tool-dev.cloudfunctions.net/sourceTrackingToolDevWriteFirestore",t="https://asia-east2-ms-source-tracking-tool-dev.cloudfunctions.net/sourceTrackingToolDevUpdateFirestore",r="_source_link_data",n=location.hostname.replace("www.","").toLocaleLowerCase(),o=document.currentScript.getAttribute("data-client-id");if(!o)return;const a=o.toUpperCase(),s=`_source_link_${a}`,c=async()=>{const t=sessionStorage.getItem(s);if(null!==t)return"true"===t;const r={clientId:a,action:"validate"};try{return new Promise((t=>{const n=new XMLHttpRequest;n.open("POST",e,!0),n.setRequestHeader("Content-Type","application/json;charset=UTF-8"),n.onreadystatechange=()=>{if(4===n.readyState)if(200===n.status)try{const e=JSON.parse(n.responseText),r=e.success&&e.isActive;sessionStorage.setItem(s,r.toString()),t(r)}catch(e){t(!1)}else t(!1)},n.onerror=()=>{t(!1)},n.send(JSON.stringify(r))}))}catch(e){return!1}},i=["utm_campaign","utm_source","utm_medium","utm_term","utm_content","utm_id","utm_source_platform","utm_creative_format","utm_marketing_tactic","fbclid","gclid","wbraid","dclid","msclkid","li_fat_id","ttclid","twclid"],d=e=>{const t=document.cookie.split(";");for(let r=0;r<t.length;r++){const n=t[r].trim();if(0===n.indexOf(e+"="))return n.substring(e.length+1)}return null},u=async(e,t,r)=>{if(!await c())return;const n=new XMLHttpRequest;n.open("POST",e,!0),n.setRequestHeader("Content-Type","application/json;charset=UTF-8"),n.onreadystatechange=()=>{if(4===n.readyState)if(200===n.status){const e=JSON.parse(n.responseText);r(e)}else n.status},n.send(JSON.stringify(t))},l=(e,t,r)=>{let n=location.hostname;n.split(".").length>2&&(n="."+n);const o=`${e}=${encodeURIComponent(t)}; expires=${r}; path=/; domain=${n};`;document.cookie=o},m=()=>{const e=new URLSearchParams(location.search),t={};return i.forEach((r=>{e.has(r)&&(t[r]=e.get(r))})),t},p=t=>{const o="v_"+Date.now()+"_"+Math.random().toString(36).slice(2,11),s={clientId:a,websiteId:n,visitorId:o,createdAt:Date.now(),sourceData:t.sourceData};u(e,s,(e=>{if(e&&e.success){const e={clientId:a,websiteId:n,visitorId:o,referrer:t.sourceData[0].referrer,createdAt:Date.now()};l(r,JSON.stringify(e),new Date(Date.now()+63072e6))}}))},f=e=>{const o=d(r),s=JSON.parse(decodeURIComponent(o)),c=s.referrer,i=s.visitorId;if(e&&(e!==n||"direct"!==e)&&!(e=>{const t=document.location.hostname.replace("www.","");return e.includes(t)})(e)){s.referrer=c+"|"+e,l(r,JSON.stringify(s),new Date(Date.now()+63072e6));const o=(e=>{const t=e.split("|");return t[t.length-1]})(s.referrer),d=m();((e,r)=>{const o={clientId:a,websiteId:n,visitorId:e,updatedAt:Date.now(),sourceData:[r]};u(t,o,(()=>{}))})(i,{createdAt:Date.now(),referrer:o,landingPage:location.pathname,queryParams:d})}},w=e=>{(e=>{const t=m(),r={sourceData:[{createdAt:Date.now(),referrer:e,landingPage:location.pathname,queryParams:t}]};p(r)})(e&&e!==n?e:"direct")},g=e=>{u(t,e,(()=>{}))};(async()=>{await c()&&((()=>{const e=d(r),t=document.referrer?new URL(document.referrer).hostname.replace("www.",""):"";e?f(t):w(t)})(),document.querySelectorAll('input[type="email"], input[name^="email"], input[name*="mail"]').forEach((e=>{e.addEventListener("blur",(()=>{const t=e.value.trim();if(t){const e=d(r);if(e)try{const r=JSON.parse(decodeURIComponent(e)).visitorId;r&&g({clientId:a,websiteId:n,visitorId:r,email:t})}catch(e){}}}))})))})()}();